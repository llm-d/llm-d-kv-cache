apiVersion: apps/v1
kind: Deployment
metadata:
  name: pvc-evictor
  namespace: <your_namespace>  # REQUIRED: Set to your namespace (e.g., e5, c3, etc.)
  labels:
    app: pvc-evictor
    component: storage-cleanup
spec:
  replicas: 1  # Single pod with N+2 processes inside (N crawlers + activator + deleter)
  selector:
    matchLabels:
      app: pvc-evictor
  template:
    metadata:
      labels:
        app: pvc-evictor
        component: storage-cleanup
    spec:
      serviceAccountName: default
      # Security Context (Pod-level)
      # NOTE: These values are namespace-specific due to Security Context Constraints (SCCs)
      # REQUIRED: Set these values for your namespace. To find your namespace's values:
      #   kubectl get pod <pod-name> -n <namespace> -o jsonpath='{.spec.securityContext}'
      #   kubectl get pod <pod-name> -n <namespace> -o jsonpath='{.spec.containers[0].securityContext}'
      securityContext:
        fsGroup: <your_fsgroup>  # REQUIRED: Set to your namespace's fsGroup. Will try to auto-detect if not provided.
        seLinuxOptions:
          level: "<your_selinux_level>"  # REQUIRED: Set to your namespace's seLinuxOptions.level. Will try to auto-detect if not provided.
        seccompProfile:
          type: "RuntimeDefault" 
      containers:
      - name: evictor
        image: ghcr.io/guygir/pvc-evictor:latest
        # Security Context (Container-level)
        securityContext:
          allowPrivilegeEscalation: false 
          capabilities:
            drop:
            - ALL  # Drop all Linux capabilities
          runAsNonRoot: true  # Run as non-root user for security
          runAsUser: <your_runasuser>  # REQUIRED: Set to your namespace's runAsUser
        env:
        # PVC Configuration
        - name: PVC_MOUNT_PATH
          value: "/kv-cache"
        
        # Threshold Configuration
        - name: CLEANUP_THRESHOLD
          value: "85.0"  # Trigger deletion above this %
        - name: TARGET_THRESHOLD
          value: "70.0"  # Stop deletion below this %
        
        # Cache Configuration
        - name: CACHE_DIRECTORY
          value: "kv/model-cache/models"  # Directory containing cache files (actual path structure)
        
        # Multi-Process Configuration
        - name: NUM_CRAWLER_PROCESSES
          value: "8"  # Number of crawler processes (valid: 1, 2, 4, 8, 16). Default: 8
        - name: LOGGER_INTERVAL_SECONDS
          value: "0.5"  # Activator process monitoring interval (seconds)
        - name: FILE_QUEUE_MAXSIZE
          value: "10000"  # MAXQ: Max items in queue when deletion is ON
        - name: FILE_QUEUE_MIN_SIZE
          value: "1000"  # MINQ: Pre-fill queue to this size when deletion is OFF
        - name: DELETION_BATCH_SIZE
          value: "100"  # Files per deletion batch (deleter process)
        - name: FILE_ACCESS_TIME_THRESHOLD_MINUTES
          value: "60"  # Skip files accessed within this time (minutes)
        
        # Safety Configuration
        - name: DRY_RUN
          value: "false"  # Set to "true" for testing without deletions
        - name: LOG_LEVEL
          value: "INFO"  # DEBUG, INFO, WARNING, ERROR
        
        # Log File Configuration (optional - logs will be written to both stdout and this file)
        - name: LOG_FILE_PATH
          value: "/tmp/evictor_all_logs.txt"
        
        volumeMounts:
        - name: kv-cache-storage
          mountPath: /kv-cache
          readOnly: false
        
        resources:
          requests:
            cpu: 1000m  # Base CPU for processes
            memory: 1Gi  # Base memory for processes
          limits:
            cpu: 4000m  # Allow more CPU for parallel processing (adjust based on NUM_CRAWLER_PROCESSES)
            memory: 2Gi  # Allow more memory for parallel processing
        
        # Health checks
        livenessProbe:
          exec:
            command:
            - python3
            - -c
            - "import os; exit(0 if os.path.exists('/kv-cache') else 1)"
          initialDelaySeconds: 30
          periodSeconds: 30
          timeoutSeconds: 5
          failureThreshold: 3
        
        readinessProbe:
          exec:
            command:
            - python3
            - -c
            - "import os; exit(0 if os.path.exists('/kv-cache') else 1)"
          initialDelaySeconds: 10
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
      volumes:
        - name: kv-cache-storage
          persistentVolumeClaim:
            claimName: <your_pvc_name>  # REQUIRED: Set to your PVC name

